name: ğŸ” Almusbah Product Monitor

on:
  # ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ Ø³Ø§Ø¹Ø©
  schedule:
    - cron: '0 * * * *'  # ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© ÙƒÙ„ Ø³Ø§Ø¹Ø©

  # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
  workflow_dispatch:

  # ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ù€ push (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  monitor:
    name: ğŸ•·ï¸ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    runs-on: ubuntu-latest

    steps:
      # 1. Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Python
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
      - name: ğŸš€ Run Monitor
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ğŸ” Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª..."
          python main.py
          echo "âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ÙØ­Øµ"

      # 5. Ø­ÙØ¸ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      - name: ğŸ’¾ Commit Database Changes
        run: |
          git config --local user.email "bot@github-actions"
          git config --local user.name "Monitor Bot"
          git add products.db backups/*.db 2>/dev/null || true
          git diff --quiet && git diff --staged --quiet || \
            (git commit -m "ğŸ¤– ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - $(date +'%Y-%m-%d %H:%M:%S')" && echo "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª")

      # 6. Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
      - name: ğŸ“¤ Push Changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      # 7. Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙƒÙ€ artifact
      - name: ğŸ“‹ Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-logs-${{ github.run_number }}
          path: |
            monitor.log
            products.db
          retention-days: 7

      # 8. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
      - name: ğŸš¨ Notify on Failure
        if: failure()
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="âš ï¸ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙŠ GitHub Actions"
